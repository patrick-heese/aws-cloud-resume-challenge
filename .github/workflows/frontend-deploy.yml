name: frontend-deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'assets/**'
      - 'index.html'
      - 'styles.css'
      - 'main.js'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  TF_DIR: terraform
  FRONTEND_DIR: frontend
  BUILD_DIR: build
  CF_DIST_ID: ""

concurrency:
  group: frontend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS via OIDC (Frontend)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::493233983993:role/GitHubOIDC-Frontend
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform init (read remote state)
        run: terraform -chdir=${{ env.TF_DIR }} init -input=false -reconfigure

      - name: Read Terraform outputs
        id: tfout
        shell: bash
        run: |
          set -euo pipefail
          # Try common output names; tolerate missing ones to compute fallbacks
          SITE_BUCKET="$(terraform -chdir=${TF_DIR} output -raw site_bucket 2>/dev/null || true)"
          CF_DIST_ID="$(terraform -chdir=${TF_DIR} output -raw cloudfront_distribution_id 2>/dev/null || true)"
          CF_DOMAIN="$(terraform -chdir=${TF_DIR} output -raw cloudfront_domain_name 2>/dev/null || true)"
          SSM_PARAM="$(terraform -chdir=${TF_DIR} output -raw ssm_api_param 2>/dev/null || true)"

          if [[ -z "${SITE_BUCKET}" ]]; then
            echo "ERROR: Terraform output 'site_bucket' not found"; exit 1
          fi
          if [[ -z "${SSM_PARAM}" ]]; then
            echo "ERROR: Terraform output 'ssm_api_param' not found"; exit 1
          fi

          # If distribution id isn't an output, derive from domain (if provided)
          if [[ -z "${CF_DIST_ID}" && -n "${CF_DOMAIN}" ]]; then
            CF_DIST_ID="$(aws cloudfront list-distributions \
              --query "DistributionList.Items[?DomainName=='${CF_DOMAIN}'].Id | [0]" \
              --output text)"
          fi

          echo "SITE_BUCKET=${SITE_BUCKET}"           >> "$GITHUB_ENV"
          echo "CF_DIST_ID=${CF_DIST_ID}"             >> "$GITHUB_ENV"
          echo "SSM_PARAM=${SSM_PARAM}"               >> "$GITHUB_ENV"

      - name: Resolve API base URL from SSM
        id: ssm
        shell: bash
        run: |
          set -euo pipefail
          API_BASE_URL="$(aws ssm get-parameter --name "${SSM_PARAM}" --with-decryption \
            --query 'Parameter.Value' --output text)"
          if [[ -z "${API_BASE_URL}" || "${API_BASE_URL}" == "None" ]]; then
            echo "ERROR: Empty API base URL from SSM param '${SSM_PARAM}'"; exit 1
          fi
          echo "API_BASE_URL=${API_BASE_URL}" >> "$GITHUB_ENV"

      - name: Build frontend bundle
        shell: bash
        run: |
          set -euo pipefail
          rm -rf "${BUILD_DIR}"
          mkdir -p "${BUILD_DIR}"
          # Copy all site files from frontend/
          rsync -av --delete "${FRONTEND_DIR}/" "${BUILD_DIR}/"
          # Overwrite config.json with runtime value (no-store at upload time)
          printf '{ "apiBaseUrl": "%s" }\n' "${API_BASE_URL}" > "${BUILD_DIR}/config.json"

      - name: Upload static assets to S3 (long cache)
        shell: bash
        run: |
          set -euo pipefail
          # Everything except config.json and index.html: cache long & immutable
          aws s3 sync "${BUILD_DIR}/" "s3://${SITE_BUCKET}/" \
            --delete \
            --exclude "config.json" \
            --exclude "index.html" \
            --cache-control "public,max-age=31536000,immutable" \
            --metadata-directive REPLACE

      - name: Upload index.html (short cache)
        if: success()
        shell: bash
        run: |
          if [[ -f "${BUILD_DIR}/index.html" ]]; then
            aws s3 cp "${BUILD_DIR}/index.html" "s3://${SITE_BUCKET}/index.html" \
              --cache-control "public,max-age=300" \
              --content-type "text/html"
          fi

      - name: Upload config.json (no-store)
        if: success()
        shell: bash
        run: |
          aws s3 cp "${BUILD_DIR}/config.json" "s3://${SITE_BUCKET}/config.json" \
            --cache-control "no-store" \
            --content-type "application/json"

      - name: Invalidate CloudFront (targeted)
        if: success() && env.CF_DIST_ID != ''
        shell: bash
        run: |
          aws cloudfront create-invalidation --distribution-id "${CF_DIST_ID}" \
            --paths "/index.html" "/config.json"

