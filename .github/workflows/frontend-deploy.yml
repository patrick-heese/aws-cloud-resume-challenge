name: frontend-deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  TF_DIR: terraform
  FRONTEND_DIR: frontend
  BUILD_DIR: build

concurrency:
  group: frontend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS via OIDC (Frontend)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::493233983993:role/GitHubOIDC-Frontend
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform init (read remote state)
        run: terraform -chdir=${{ env.TF_DIR }} init -input=false -reconfigure

      - name: Read Terraform outputs
        id: tfout
        shell: bash
        run: |
          set -euo pipefail
          SITE_BUCKET="$(terraform -chdir=${TF_DIR} output -raw site_bucket)"
          CF_DIST_ID="$(terraform -chdir=${TF_DIR} output -raw cloudfront_distribution_id)"
          SSM_PARAM="$(terraform -chdir=${TF_DIR} output -raw ssm_api_param)"

          echo "site_bucket=${SITE_BUCKET}"   >> "$GITHUB_OUTPUT"
          echo "cf_dist_id=${CF_DIST_ID}"     >> "$GITHUB_OUTPUT"
          echo "ssm_param=${SSM_PARAM}"       >> "$GITHUB_OUTPUT"

      - name: Resolve API base URL from SSM
        id: ssm
        shell: bash
        env:
          SSM_PARAM: ${{ steps.tfout.outputs.ssm_param }}
        run: |
          set -euo pipefail
          API_BASE_URL="$(aws ssm get-parameter --name "${SSM_PARAM}" --with-decryption \
            --query 'Parameter.Value' --output text)"
          if [[ -z "${API_BASE_URL}" || "${API_BASE_URL}" == "None" ]]; then
            echo "ERROR: Empty API base URL from SSM param '${SSM_PARAM}'"; exit 1
          fi
          echo "api_base_url=${API_BASE_URL}" >> "$GITHUB_OUTPUT"

      - name: Build frontend bundle
        shell: bash
        env:
          API_BASE_URL: ${{ steps.ssm.outputs.api_base_url }}
          FRONTEND_DIR: ${{ env.FRONTEND_DIR }}
          BUILD_DIR: ${{ env.BUILD_DIR }}
        run: |
          set -euo pipefail
          rm -rf "${BUILD_DIR}"
          mkdir -p "${BUILD_DIR}"
          rsync -av --delete "${FRONTEND_DIR}/" "${BUILD_DIR}/"
          printf '{ "apiBaseUrl": "%s" }\n' "${API_BASE_URL}" > "${BUILD_DIR}/config.json"

      - name: Upload static assets to S3 (long cache)
        shell: bash
        env:
          SITE_BUCKET: ${{ steps.tfout.outputs.site_bucket }}
          BUILD_DIR: ${{ env.BUILD_DIR }}
        run: |
          set -euo pipefail
          aws s3 sync "${BUILD_DIR}/" "s3://${SITE_BUCKET}/" \
            --delete \
            --exclude "config.json" \
            --exclude "index.html" \
            --cache-control "public,max-age=31536000,immutable" \
            --metadata-directive REPLACE

      - name: Upload index.html (short cache)
        if: success()
        shell: bash
        env:
          SITE_BUCKET: ${{ steps.tfout.outputs.site_bucket }}
          BUILD_DIR: ${{ env.BUILD_DIR }}
        run: |
          if [[ -f "${BUILD_DIR}/index.html" ]]; then
            aws s3 cp "${BUILD_DIR}/index.html" "s3://${SITE_BUCKET}/index.html" \
              --cache-control "public,max-age=300" \
              --content-type "text/html"
          fi

      - name: Upload config.json (no-store)
        if: success()
        shell: bash
        env:
          SITE_BUCKET: ${{ steps.tfout.outputs.site_bucket }}
          BUILD_DIR: ${{ env.BUILD_DIR }}
        run: |
          aws s3 cp "${BUILD_DIR}/config.json" "s3://${SITE_BUCKET}/config.json" \
            --cache-control "no-store" \
            --content-type "application/json"

      - name: Invalidate CloudFront (targeted)
        if: success() && steps.tfout.outputs.cf_dist_id != ''
        shell: bash
        env:
          CF_DIST_ID: ${{ steps.tfout.outputs.cf_dist_id }}
        run: |
          aws cloudfront get-distribution --id "${CF_DIST_ID}" > /dev/null
          aws cloudfront create-invalidation --distribution-id "${CF_DIST_ID}" \
            --paths "/index.html" "/config.json"
